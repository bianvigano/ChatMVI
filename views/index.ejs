<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>
    <%= title || 'Chat MVI' %>
  </title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .wrap {
      max-width: 920px;
      margin: 0 auto;
      padding: 16px
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap
    }

    .btn {
      padding: 10px 16px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      text-decoration: none
    }

    .card {
      border: 1px solid #eee;
      border-radius: 16px;
      padding: 16px;
      flex: 1;
      min-width: 260px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, .04)
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px
    }

    .modal-card {
      background: #fff;
      border-radius: 16px;
      max-width: 420px;
      width: 100%;
      padding: 16px
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px
    }

    .tab {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 8px 12px;
      background: #f9f9f9;
      cursor: pointer
    }

    .tab.active {
      background: #fff;
      font-weight: 600
    }

    label {
      display: block;
      font-size: 14px;
      margin: 8px 0 4px
    }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px
    }
  </style>
</head>

<body>
  <% if (!user) { %>
    <!-- BELUM LOGIN: Landing -->
    <div class="wrap" style="text-align:center;margin-top:10vh">
      <h1>ChatMVI</h1>
      <p>Silakan login atau daftar untuk mulai.</p>
      <p>
        <a class="btn" href="/login">Login</a>
        <a class="btn" href="/register">Register</a>
      </p>
      <div style="margin-top:24px;color:#666;font-size:14px">
        <p>Info: versi demo. Setelah login, kamu akan masuk ke menu & bisa pilih room.</p>
      </div>
    </div>
    <% } else { %>
      <!-- SUDAH LOGIN: Menu + Modal Room -->
      <div class="wrap">
        <header class="row" style="align-items:center;justify-content:space-between">
          <div>Halo, <strong>
              <%= user.username || user.name || 'User' %>
            </strong></div>
          <nav class="row"><a class="btn" href="/logout">Logout</a></nav>
        </header>

        <main class="row" style="margin-top:16px">
          <section class="card">
            <h2>Mulai</h2>
            <p>Bergabung ke Room untuk chat.</p>
            <a class="btn" href="/r/global">Masuk Global (GET)</a>
            <button id="btnOpenRoom" class="btn">Buka Modal Room</button>
          </section>
        </main>
      </div>

      <!-- Modal room (opsional). Boleh tanpa tab Global. -->
      <div id="loginModal" class="modal" style="display:none">
        <div class="modal-card">
          <div class="tabs">
            <!-- tombol ini opsional, JS pakai optional chaining -->
            <button id="btnTabGlobal" class="tab">Global</button>
            <button id="btnTabPrivate" class="tab active">Private</button>
          </div>

          <div id="globalPanel" style="display:none">
            <!-- boleh dikosongkan / dihilangkan -->
            <form method="post" action="/join/global">
              <div class="row" style="justify-content:flex-end">
                <button type="submit" class="btn">Masuk Global</button>
              </div>
            </form>
          </div>

          <div id="privatePanel">
            <form method="post" action="/room/join">
              <label>Room</label>
              <input name="roomId" placeholder="contoh: tim-a" required />
              <label>Password</label>
              <input name="password" type="password" placeholder="••••••" />
              <div class="row" style="margin-top:8px;justify-content:flex-end">
                <button type="button" class="btn" id="btnCloseModal">Batal</button>
                <button type="submit" class="btn">Masuk Room</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <script>
        (function () {
          const modal = document.getElementById('loginModal');
          const btnOpen = document.getElementById('btnOpenRoom');
          const btnClose = document.getElementById('btnCloseModal');
          btnOpen?.addEventListener('click', () => { modal.style.display = 'flex'; });
          btnClose?.addEventListener('click', () => { modal.style.display = 'none'; });
          modal?.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

          const btnTabGlobal = document.getElementById('btnTabGlobal');
          const btnTabPrivate = document.getElementById('btnTabPrivate');
          const globalPanel = document.getElementById('globalPanel');
          const privatePanel = document.getElementById('privatePanel');

          btnTabGlobal?.addEventListener('click', () => {
            btnTabGlobal.classList.add('active'); btnTabPrivate?.classList.remove('active');
            if (globalPanel) globalPanel.style.display = 'block';
            if (privatePanel) privatePanel.style.display = 'none';
          });

          btnTabPrivate?.addEventListener('click', () => {
            btnTabPrivate.classList.add('active'); btnTabGlobal?.classList.remove('active');
            if (privatePanel) privatePanel.style.display = 'block';
            if (globalPanel) globalPanel.style.display = 'none';
          });
        })();
      </script>
      <% } %>

        <script src="/socket.io/socket.io.js"></script>
        <script>
          const socket = io();                     // konek ke namespace default
          socket.on('connect', () => console.log('[CLIENT] connected', socket.id));
          socket.on('connect_error', (e) => console.log('[CLIENT] connect_error', e));
        </script>
</body>

</html>